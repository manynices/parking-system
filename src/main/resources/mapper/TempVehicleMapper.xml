<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.experiment.parkingsystem.mapper.TempVehicleMapper">

    <insert id="insert" useGeneratedKeys="true" keyProperty="registrationId">
        INSERT INTO temp_vehicle
        (license_plate, vehicle_type, applicant_name, applicant_phone, visit_unit, visit_reason, expected_enter_time, expected_exit_time, host_name, host_phone, status, create_time)
        VALUES
            (#{licensePlate}, #{vehicleType}, #{applicantName}, #{applicantPhone}, #{visitUnit}, #{visitReason}, #{expectedEnterTime}, #{expectedExitTime}, #{hostName}, #{hostPhone}, #{status}, #{createTime})
    </insert>

    <update id="updateEntry">
        UPDATE temp_vehicle
        SET entry_time = #{entryTime},
            entry_device_id = #{entryDeviceId},
            entry_image = #{entryImage},
            status = #{status},
            remark = #{remark}
        WHERE registration_id = #{registrationId}
    </update>

    <update id="updateExit">
        UPDATE temp_vehicle
        SET exit_time = #{exitTime},
            exit_device_id = #{exitDeviceId},
            exit_image = #{exitImage},
            parking_duration = #{parkingDuration},
            parking_fee = #{parkingFee},
            payment_method = #{paymentMethod},
            status = #{status}
        WHERE registration_id = #{registrationId}
    </update>

    <select id="selectList" resultType="com.experiment.parkingsystem.entity.TempVehicle">
        SELECT * FROM temp_vehicle
        <where>
            <if test="licensePlate != null and licensePlate != ''">AND license_plate LIKE CONCAT('%', #{licensePlate}, '%')</if>
            <if test="status != null and status != ''">AND status = #{status}</if>
            <if test="startDate != null">AND create_time &gt;= #{startDate}</if>
            <if test="endDate != null">AND create_time &lt;= #{endDate}</if>
        </where>
        ORDER BY create_time DESC
    </select>

    <select id="selectLatestActiveByPlate" resultType="com.experiment.parkingsystem.entity.TempVehicle">
        SELECT * FROM temp_vehicle
        WHERE license_plate = #{licensePlate}
          AND status IN ('待入场', '在场')
        ORDER BY create_time DESC
            LIMIT 1
    </select>

</mapper>